#!/usr/bin/env bash
set -euo pipefail
# Hard guard: ensure we only commit working, emulator-validated code.

# Allow bypass with ALLOW_DIRTY_COMMIT=1 in env
if [[ "${ALLOW_DIRTY_COMMIT:-}" == "1" ]]; then
  echo "[pre-commit] Bypass enabled (ALLOW_DIRTY_COMMIT=1)."
  exit 0
fi

# Require absence of NEEDS_EMULATOR_CHECK marker
if [[ -f NEEDS_EMULATOR_CHECK ]]; then
  echo "[pre-commit] Blocked: NEEDS_EMULATOR_CHECK marker present. Validate on emulator then remove it."
  exit 1
fi

# Require presence of .validated marker
if [[ ! -f .validated ]]; then
  echo "[pre-commit] Blocked: .validated marker missing. Build & run on emulator, then: touch .validated"
  exit 1
fi

# Build + unit tests + coverage check
echo "[pre-commit] Running build + unit tests + coverage"
if ! ./gradlew :app:assembleDebug testDebugUnitTest jacocoTestReport jacocoCoverageCheck -q; then
  echo "[pre-commit] Blocked: build/tests/coverage failed." >&2
  exit 1
fi

# Verify coverage report exists
REPORT_PATH="app/build/reports/jacoco/jacocoTestReport/html/index.html"
if [[ ! -f "$REPORT_PATH" ]]; then
  echo "[pre-commit] Blocked: Coverage report missing at $REPORT_PATH" >&2
  exit 1
fi
echo "[pre-commit] Coverage report: $REPORT_PATH"

echo "[pre-commit] All checks passed. Proceeding with commit."
